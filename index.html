<!DOCTYPE html>
<!-- saved from url=(0065)http://html5slides.googlecode.com/svn/trunk/template/index.html#1 -->
<html>
<head>
    <title>"The Website's Slow" - Tips and Tools for Identifying Performance Bottlenecks</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Arizonia' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="reveal/reset.css">

    <link rel="stylesheet" href="reveal/custom.css">
    <link rel="stylesheet" href="reveal/heart.css">
    <link rel="stylesheet" href="reveal/print.css" type="text/css" media="print">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script> 
</head>
<body>
<div class="reveal linear">

<!-- Used to fade in a background when a specific slide state is reached -->
<div class="state-background"></div>

<!-- Any section element inside of this container is displayed as a slide -->
<div class="slides">

<section>
    <h1>
      "The Website's Slow"
    </h1>
    <p style="color: white;">
      Tips and Tools for Identifying Performance Bottlenecks
    </p>
</section>

<section class="center-slide">
  <h1>Who I am</h1>
  <p style="color: white;">
    And why you should listen to me
  </p>
  <!-- 
      They say when you give a talk, you should let the audience know your qualifications.
    -->
</section>
  
<section>
    <h3>My name is Sammy Larbi</h3>
    <div class="fragment subsection">
      <h3>I'm a freelance Ruby developer</h3>
    </div>
    <div class="fragment subsection">
      <h3>6 years playing with Rails</h3>
      <!-- Until I recently looked it up, apparently I've had 4 for the last 3 -->
    </div>
    <div class="fragment subsection">
      <h3>4 projects recently needed P.E.D.</h3>
    </div>
    <div class="fragment subsection">
      (Performance Enhancing Development)
    </div>
</section>

<section>
  <h2>
    Interrupt Me
  </h2>
  <!-- 
    I want this to be valuable for you, so if I haven't explained something clearly, 
    let me know about it. 
  -->
</section>

<section>
  <h1>
    "The Website's Slow"
  </h1>
</section>

<section>
  <img src="images/slow.png" height="500" alt="The customer tells you 'The website is slow'"/>
  <!-- from iphonetextgenerator.com -->
</section>

<section>
  <img src="images/link.png" height="500" alt="You respond, asking which webpage"/>
</section>

<section class="center-slide">
  <h1>Isolated Actions</h1>
  <!-- The easy stuff -->
</section>

<section>
  <img src="images/nplus1.png" alt="n+1 queries in an action" width="900"/>
</section>

<section>
  <img src="images/slowquery.png" alt="slow query in an action" width="900"/>
</section>

<section>
  <p style="color: white;">
  Or maybe your app resides on one network 
  and your DB on another, and you're doing
  </p>
  <h2>
  <code>select * from a_table</code>
  </h2> 
  <p style="color: white;">
    with 
    many records &amp; a ton of <h2 style="display: inline;">BLOB</h2> 
    <span style="color: white;">
      columns you have to transfer
    </span>
  </p>
</section>

<section class="center-slide">
  <h2>Measurement</h2>
  <!--
    In all of these easy cases, you're looking at Rails log files which contain measurements 
    of the time queries take to complete or views/partials take to render. In development
    mode, it's easy to reload a few times to get a baseline, make your changes, and reload
    a couple of times to see if there is improvement.
  -->
</section>

<section>
  <br/><br/>
  <h2>Data Anonymity</h2>
  <div class="fragment subsection">
    <h2>Visibility</h2>
  </div>
  <!-- 
    But rather than looking through the pollution of the entire log file, there are some tools 
    to help you make these problems and measurements more visible.
  --> 
</section>


<section>
  <h2 style="margin-bottom: 0;">rails-footnotes</h2>
  <img src="images/railsfootnotes.png" alt="Example of information rails-footnotes provides."/>
  <br/><br/>
  <div align="right">
    <small><a href="https://github.com/josevalim/rails-footnotes">rails-footnotes @ github</a></small>
  </div>
  <!--
    When I first moved to Rails, one of the things I missed most about ColdFusion was all the information
    they included at the bottom of the page for each request. Rails-footnotes gets me that information, 
    and includes which line of code in which file generated the query, which is helpful when you have
    one of a bunch of queries you need to optimize, and don't immediately know where to look.
  -->
</section>

<section>
  <h2 style="margin-bottom: 0;">bullet</h2>
  <img src="images/bulletnotification.png" alt="Example of information the bullet gem provides."/>
  <br/><br/>
  <div align="right">
    <small><a href="https://github.com/flyerhzm/bullet">bullet @ github</a></small>
  </div>
  <!--
    Bullet can notify us of N+1 query problem, unused eager loading, and the need for a counter cache.
    I've shown it logging in the javascript console, but it can also use a js alert, growl notification,
    or log to the Rails log file. 
  -->
</section>

<section>
  <h2>rack-insight</h2>
  <div align="right">
    <small><a href="https://github.com/pboling/rack-insight">rack-insight @ github</a></small>
  </div>
  <!-- 
    Works as a rack middleware with all kinds of cool options, but looks to need some more 
    work. I'd like to use it once I can spare enough time to contribute back to the project
  -->
</section>

<section class="center-slide">
  <h2>Granularity</h2>
</section>

<section>
  <h2 style="margin-bottom: 0;">ruby-prof</h2> 
  <img src="images/rubyprof-callstack.png" alt="Example of information ruby-prof provides in the call tree printer."/>
  <div align="right">
    <small><a href="https://github.com/rdp/ruby-prof">ruby-prof @ github</a></small>
    <small><a href="resources/ruby-prof/ruby-prof-call-tree.html" target="example">example</a></small>
    <small><a href="https://github.com/jruby/jruby/wiki/Profiling-jruby">jruby's got you covered</a></small>
  </div>
  <!-- 
    See the example for how to see where the call tree gets interesting
    There are a couple of ways to use it in your rails app
  -->
</section>

<section>
  <h2 style="margin-bottom: 0;">ruby-prof</h2>
  <h3>entire action</h3>
  <div class="code small">
    <code>
    gem 'ruby-prof', groups: [:development, :profile] # in Gemfile
    </code>
  </div>
  <div class="code small">
    <code>
      if Rails.env.profile? # in config.ru<br/>
      &nbsp;&nbsp;use Rack::RubyProf, :path => '/temp/profile'<br/>
      end
    </code>
  </div>
  <div class="code small">
    <code>
    # profile db connection settings in config/database.yml<br/>
    # (same as dev environment is fine)<br/>
    </code>
  </div>
  <div class="code small">
      <code>
        # Create config/environments/profile.rb with at least these options:<br/>
        config.cache_classes = true<br/>
        config.cache_template_loading = true
      </code>
  </div>
  <div class="code small">
    <code>
    # bundle install and restart with: rails s -e profile<br/>
    </code>
  </div>
  <div align="right">
    <small><a href="https://github.com/rdp/ruby-prof">code from ruby-prof @ github</a></small>
  </div>
  <!-- 
    The docs mention you should create a profiling environment when you do this. I agree. The 
    standard ruby profiler is slow because it's pure ruby, and ruby prof is faster because it's 
    a C extension. But it's still slow, so you don't want to always have it running in development
    mode.
  -->
</section>


<section>
  <h2 style="margin-bottom: 0;">ruby-prof</h2>
  <h3>specific lines of code</h3>
  <div class="code">
    <code>
      result = RubyProf.profile do<br/>
      &nbsp;&nbsp;...<br/>
      &nbsp;&nbsp;[code to profile]<br/>
      &nbsp;&nbsp;...<br/>
      end<br/>
      <br/>
      printer=RubyProf::GraphPrinter.new(result)<br/>
      printer.print(STDOUT, {})<br/>
    </code>
  </div>
  <div align="right">
    <small><a href="https://github.com/rdp/ruby-prof">code from ruby-prof @ github</a></small>
  </div>
  <!-- 
    If you know what your looking for, or just want to see how a more 
    granular section of code looks when profiled, you can use 
    RubyProf like this.
  -->
</section>



<section>
  <h2>benchmark</h2>
  
  <div class="code small">
    <code><pre>
Benchmark.bm do |x|
  x.report("find by id: ") { 
    @student = Student.find_by_id(params[:student_id]) 
  }
  
  x.report("find: ") { 
    @student = @district.students.find(params[:student_id]) 
  }
end
    </pre></code>
  </div>
  
  <div class="code small">
    <code><pre>
       user     system      total        real
find by id:   0.090000   0.000000   0.090000 (  1.352654)
find:   0.030000   0.000000   0.030000 (  0.030710)
    </pre></code>
  </div>
  
  <div align="right">
    <small><a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/benchmark/rdoc/Benchmark.html">benchmark docs</a></small>
  </div>
</section>

<section>
  <h2>Further Investigation</h2>
  <h3 style="display: inline;"><a href="https://github.com/tmm1/perftools.rb">perftools.rb</a></h3> <a href="http://perftools-rb.rubyforge.org/examples/rails.gif" target="example">(example output)</a>
  <!-- perftools.rb also has a way to run in dev mode and only profile when you send the profile parameter with the request -->
  <h3><a href="http://guides.rubyonrails.org/performance_testing.html">rails performance testing</a></h3>
</section>


<section>
  <img src="images/slow.png" height="500" alt="The customer tells you 'The website is slow'"/>
  <!-- from iphonetextgenerator.com -->
</section>

<section>
  <img src="images/link.png" height="500" alt="You respond, asking which webpage"/>
</section>

<section>
  <img src="images/everywhere.png" height="500" alt="The customer says 'everywhere'"/>
</section>


<section class="center-slide">
  <h1>Server Issues</h1>
</section>
<section class="center-slide">
  <h2>Memory</h2>
</section>

<section>
  <h2 style="margin-bottom: 0;">top</h2>
  <img src="images/top-swap.png" alt="output of command: top (highlighting the swap memory in use)"/>
  <h2 style="margin-bottom: 0;">free</h2>
  <img src="images/free-swap.png" alt="output of command: free (highlighting the swap memory in use)"/>
  <!-- 
    here we're highlighting the amount of swap memory in use 
    when it's high, you're likely maxing out your RAM and swapping 
    to disk a lot, which is super slow, especially on shared 
    servers (like the cloud!) when who knows how many people 
    are trying to access the hard drive at the same time.
  -->
</section>

<section>
  <h2>Per process:</h2>
  <h3>ps aeux --sort=-vsz</h>
  <img src="images/ps.png" alt="output of command: ps aeux --sort=-vsz"/>
  <!-- 
    In this case, two unicorn worker processes, MySQL and Resque are eating up 
    almost all of the RAM. There are 4 processors, but we can only utilize two 
    for incoming web requests, because of the RAM issue.
    
    So, you need more RAM, or to consume less
  -->
</section>

<section>
  <!-- most of Rails world is still on having multiple worker processes, but that should change -->
  <h2 style="margin-bottom: 0;">puma</h2>
  <div class="fragment subsection" style="margin-top: 0;">
    Uses <h3 style="display: inline;">threads</h3> instead of worker processes
    <!-- 
      which saves a ton of RAM 
    -->
  </div>
  <div class="fragment subsection" style="margin-top: 0;">
    <blockquote>
      i.e., how a web server is supposed to work
    </blockquote>
    <cite>-Wes Gamble</cite>
    <!-- 
      and as our own Wes Gamble said "i.e., how a web server is supposed to work"
    -->
  </div>
  <div align="right">
    <small><a href="https://github.com/puma/puma">puma @ github</a></small>
  </div>
</section>

<section>
  <!-- most of Rails world is still on having multiple worker processes, but that should change -->
  <h2 style="margin-bottom: 0;">puma</h2>
  <div class="fragment subsection" style="margin-top: 0;">
    Use JRuby or Rubinius to take full advantage 
    <!-- 
      they use native threads, no GIL 
      you will get some improvement with CRuby when doing things outside of Ruby like DB / disk work,
      but you will get the full improvement with JRuby or Rubinius
    -->
  </div>
  <div class="fragment subsection" style="margin-top: 0;">
    <div class="code">
      <code> 
      # in config/environments/production.rb<br/>
      config.threadsafe!
      </code>
    </div>
    <!-- until it's removed or on by default after Rails 4 -->
  </div>
  <div align="right">
    <small><a href="https://github.com/puma/puma">puma @ github</a></small>
  </div>
  
</section>

<section class="center-slide">
  <h2>CPU</h2>
</section>

<section>
  <br/>
  # processor cores available / avg load time (s/page) * 60 (s/min)<br/>
  =><br/>
  <h2>max throughput in pages per minute</h2>
  
  <!-- 
    It's not likely the code running once will be a problem for the CPU by itself,
    but with a lot of requests happening at a time, it could be. That's where we 
    need to consider the max throughput of our system.
    
    So say you have 4 cores and an average page load time of 1 second. Then you'll max 
    out at around 240 requests per minute.
    
    It'll probably be a little less, because other stuff has to have a little time to run, but
    you know that's the theoretical best you can do.
    
    If you're getting close to that, you can either add more CPUs (and RAM, if you're using 
    multiple processes instead of threading), or need to figure out where you can trim
    your response times.
  -->
</section>

<section class="center-slide">
  <!-- For that, you need a more -->
  <h1>Holistic View</h1>
</section>

<section class="center-slide">
  rails log analyzer https://github.com/wvanbergen/request-log-analyzer
  new relic
  look at 
    rails metrics http://blog.plataformatec.com.br/2010/02/rails-metrics-know-what-is-happening-inside-your-rails-3-application/
    https://github.com/twinturbo/harness with https://github.com/etsy/statsd 
    harness could be external with stathat or librato
    or as engine to your rails app https://github.com/nearinfinity/system-metrics
</section>

<section>
  Does this stuff fit anywhere?
  h. does this fit anywhere? https://github.com/duncanbeevers/rails_view_annotator
  j. system level: http://auxesis.github.com/visage/ with collectd
  l. http://www.slideshare.net/goncalossilva/pdis2
</section>


<section>
  <h2>OMG Thanks!</h2>
  <br/>
  <ul style="-webkit-transform: rotate(20deg);">
    <li>Code:<br/><a href="https://github.com/codeodor">https://github.com/codeodor</a></li>
    <li>Blog:<br/><a href="http://www.codeodor.com">http://www.codeodor.com</a></li>
    <li>Tweet:<br/><a href="http://twitter.com/codeodor">@codeodor</a></li>
  </ul>
</section>


<!-- example slides -->
<section>
  <h2>Shiny happy people...</h2>
  <ul class="list">
    <li>holding hands,</li>
    <li>laughing,</li>
    <li>REM song</li>
  </ul>
</section>

<section class="center-slide">
  <h3>Something here</h3>
  <h3 class="fragment">for <strong>strong effect</strong></h3>
</section>


<section class="center-slide">
  <h2>Leads to</h2>
  <p>Howdy ho!</p>
</section>

<section>
  <blockquote>This is a long quote, wherein the speaker says something very profound.</blockquote>
  <cite>- Auturo de quota</cite>
</section>

<!-- end example slides -->



<div id="hearts"></div>
<script type="text/javascript">
  function moveHearts(){
    var numHearts = 4 + Math.random() * 3;

    $('#hearts').html("");
    for(var i=0; i < numHearts; i++)
      $('#hearts').append('<div class="heart" style="position: absolute;"></div>');
      
    $('.heart').each(function(index, heart){
      $(heart).css('top', Math.random() * 100 + '%');
      $(heart).css('left', Math.random() * 100 + '%');
      var degrees = -35 + Math.random() * 70;
      $(heart).css('transform', 'rotate(' + degrees + 'deg)');
    });
  }
  moveHearts();
</script>

</div>

<!-- The navigational controls UI -->
<aside class="controls">
  <a class="left" href="#">&#x25C4;</a>
  <a class="right" href="#">&#x25BA;</a>
  <a class="up" href="#">&#x25B2;</a>
  <a class="down" href="#">&#x25BC;</a>
</aside>

<!-- Presentation progress bar -->
<div class="progress"><span></span></div>

</div>
    <script src="libraries/head.min.js"></script>

    <script>
      // Scripts that should be loaded before initializing
      var scripts = [];

      // If the browser doesn't support classList, load a polyfill
      if( !document.body.classList ) {
        scripts.push( 'libraries/classList.js' );
      }

      // Load markdown parser if there are slides defined using markdown
      if( document.querySelector( '[data-markdown]' ) ) {
        scripts.push( 'lib/js/showdown.js' );
        scripts.push( 'lib/js/data-markdown.js' );
      }

      // If we're runnning the notes server we need to include some additional JS
      // TODO Is there a better way to determine if we're running the notes server?
      if( window.location.host === 'localhost:1947' ) {
        scripts.push( 'socket.io/socket.io.js' );
        scripts.push( 'plugin/speakernotes/client.js' );
      }

      scripts.push( 'libraries/reveal.js' );

      // Load the scripts and, when completed, initialize reveal.js
      head.js.apply( null, scripts.concat([function() {

        // Fires when a slide with data-state=customevent is activated
        Reveal.addEventListener( 'customevent', function() {
          console.log( '"customevent" has fired' );
        } );

        // Fires each time a new slide is activated
        Reveal.addEventListener( 'slidechanged', function( event ) {
          // event.previousSlide, event.currentSlide, event.indexh, event.indexv
          moveHearts();
        } );

        // Full list of configuration options available here:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
          controls: true,
          progress: true,
          history: true,

          theme: Reveal.getQueryHash().theme || 'default', // default/neon/beige
          transition: Reveal.getQueryHash().transition || 'default' // default/cube/page/concave/linear(2d)
        });

      }]));

    </script>
</body>
</html>